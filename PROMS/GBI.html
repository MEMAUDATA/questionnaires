<!DOCTYPE html>
<html lang="fr">
  <head>
    <!-- Author's details-->
        <meta name="author" content="Nicolas Vannson">
        <meta name="contact" content="hello@memau.eu">
        <meta name="license" content="EUPLv1.2">
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/3.0.0/jspdf.umd.min.js"></script>
        <script src= https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js ></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
        <link rel="stylesheet" href="/style.css">
        <style>
          /* style is within the style.css sheet */
        </style>
  <title>Questionnaire GBI</title>
  </head>
  <body>
    <h1>Glasgow Benefit Intervention (GBI)</h1>
    <p > Robinson et al., 1996 </p>
    <p > <b>Instructions : </b></p>
    <p >Quel est l’impact de votre <b>intervention</b> (chirurgie, prothèse(s) auditive(s)) sur votre vie actuelle?<br>
      Choisissez la réponse qui se rapproche le plus de votre expérience quotidienne.</p>
    <br>

    <form id="GBI">
        <table>
          <thead>
            <tr>
              <th></th>
              <th >Très nette amélioration</th>
              <th >Nette amélioration</th>
              <th >Pas de changement</th>
              <th>Légère déterioration</th>
              <th >Très forte déterioration</th> 
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="Question_GBI">1. Le résultat de l’intervention a-t-il affecté vos
                activités ? </td>
              <td><input type="radio" name="q1" value="5"></td>
              <td><input type="radio" name="q1" value="4"></td>
              <td><input type="radio" name="q1" value="3"></td>
              <td><input type="radio" name="q1" value="2"></td>
              <td><input type="radio" name="q1" value="1"></td>

            </tr>
            <tr>
              <td class="Question_GBI">2. Les résultats de l’intervention ont-ils rendu
                votre vie plus agréable ou plus désagréable ?</td>
              <td><input type="radio" name="q2" value="5"></td>
              <td><input type="radio" name="q2" value="4"></td>
              <td><input type="radio" name="q2" value="3"></td>
              <td><input type="radio" name="q2" value="2"></td>
              <td><input type="radio" name="q2" value="1"></td>
            </tr>
            <thead>
              <tr>
                <th ></th>
                <th >Beaucoup plus</th>
                <th >Plus</th>
                <th >Pas de changement</th>
                <th >Moins</th>
                <th >Beaucoup moins</th> 
              </tr>
            </thead>


            <tr>
              <td class="Question_GBI">3. Depuis votre intervention, vous sentez-vous plus (ou moins) optimiste face à l’avenir ? </td>
              <td><input type="radio" name="q3" value="5"></td>
              <td><input type="radio" name="q3" value="4"></td>
              <td><input type="radio" name="q3" value="3"></td>
              <td><input type="radio" name="q3" value="2"></td>
              <td><input type="radio" name="q3" value="1"></td>
            </tr>
            <tr>
              <td class="Question_GBI">4. Depuis votre intervention, vous sentez-vous plus (ou moins) gêné(e) lorsque vous vous trouvez en groupe?</td>
              <td><input type="radio" name="q4" value="1"></td>
              <td><input type="radio" name="q4" value="2"></td>
              <td><input type="radio" name="q4" value="3"></td>
              <td><input type="radio" name="q4" value="4"></td>
              <td><input type="radio" name="q4" value="5"></td>
            </tr>
            <tr>
              <td class="Question_GBI">5. Depuis votre opération, avez-vous plus (ou
                moins) de confiance en vous ? </td>
              <td><input type="radio" name="q5" value="5"></td>
              <td><input type="radio" name="q5" value="4"></td>
              <td><input type="radio" name="q5" value="3"></td>
              <td><input type="radio" name="q5" value="2"></td>
              <td><input type="radio" name="q5" value="1"></td>
            </tr>
            <tr>
              <td class="Question_GBI">6. Depuis votre intervention, vous est-il plus (ou
                moins) facile d’avoir affaire à d’autres
                personnes ?</td>
              <td><input type="radio" name="q6" value="5"></td>
              <td><input type="radio" name="q6" value="4"></td>
              <td><input type="radio" name="q6" value="3"></td>
              <td><input type="radio" name="q6" value="2"></td>
              <td><input type="radio" name="q6" value="1"></td>
            </tr>
            <tr>
              <td class="Question_GBI">7. Depuis votre intervention, avez-vous l’impression d’avoir plus (ou moins) de soutien de la part de vos amis ?</td>
              <td><input type="radio" name="q7" value="5"></td>
              <td><input type="radio" name="q7" value="4"></td>
              <td><input type="radio" name="q7" value="3"></td>
              <td><input type="radio" name="q7" value="2"></td>
              <td><input type="radio" name="q7" value="1"></td>
            </tr>
            <tr>
              <td class="Question_GBI">8. Depuis votre intervention, êtes-vous allé(e)
                trouver votre médecin de famille plus (ou moins)
                souvent ?</td>
              <td><input type="radio" name="q8" value="1"></td>
              <td><input type="radio" name="q8" value="2"></td>
              <td><input type="radio" name="q8" value="3"></td>
              <td><input type="radio" name="q8" value="4"></td>
              <td><input type="radio" name="q8" value="5"></td>
            </tr>
            <tr>
              <td class="Question_GBI">9. Depuis votre intervention, vous ressentez-vous
                plus (ou moins) de confiance face à des
                occasions d’emploi?</td>
              <td><input type="radio" name="q9" value="1"></td>
              <td><input type="radio" name="q9" value="2"></td>
              <td><input type="radio" name="q9" value="3"></td>
              <td><input type="radio" name="q9" value="4"></td>
              <td><input type="radio" name="q9" value="5"></td>
            </tr>
            <tr>
              <td class="Question_GBI">10. Depuis votre intervention, vous sentez-vous
                plus timide ou moins timide ? </td>
              <td><input type="radio" name="q10" value="1"></td>
              <td><input type="radio" name="q10" value="2"></td>
              <td><input type="radio" name="q10" value="3"></td>
              <td><input type="radio" name="q10" value="4"></td>
              <td><input type="radio" name="q10" value="5"></td>
            </tr>
            <tr>
              <td class="Question_GBI">11. Depuis votre intervention, y a-t-il davantage ou moins de gens qui s’occupent vraiment de vous ?</td>
              <td><input type="radio" name="q11" value="1"></td>
              <td><input type="radio" name="q11" value="2"></td>
              <td><input type="radio" name="q11" value="3"></td>
              <td><input type="radio" name="q11" value="4"></td>
              <td><input type="radio" name="q11" value="5"></td>
            </tr>
            <tr>
              <td class="Question_GBI">12. Depuis votre intervention, êtes-vous sujet(te) à des rhumes ou infections plus souvent ou moins souvent ?</td>
              <td><input type="radio" name="q12" value="1"></td>
              <td><input type="radio" name="q12" value="2"></td>
              <td><input type="radio" name="q12" value="3"></td>
              <td><input type="radio" name="q12" value="4"></td>
              <td><input type="radio" name="q12" value="5"></td>
            </tr>
            <tr>
              <td class="Question_GBI">13. Depuis votre intervention, devez-vous prendre
                plus (ou moins) de médicaments ?</td>
              <td><input type="radio" name="q13" value="1"></td>
              <td><input type="radio" name="q13" value="2"></td>
              <td><input type="radio" name="q13" value="3"></td>
              <td><input type="radio" name="q13" value="4"></td>
              <td><input type="radio" name="q13" value="5"></td>
            </tr>
            <tr>
              <td class="Question_GBI">14. Depuis votre intervention, vous sentez-vous
                plus (ou moins) en bonne santé? </td>
              <td><input type="radio" name="q14" value="5"></td>
              <td><input type="radio" name="q14" value="4"></td>
              <td><input type="radio" name="q14" value="3"></td>
              <td><input type="radio" name="q14" value="2"></td>
              <td><input type="radio" name="q14" value="1"></td>
            </tr>
            <tr>
              <td class="Question_GBI">15. Depuis votre opération, avez-vous l’impression d’avoir été plus soutenu(e) ou moins soutenu(e) par votre famille ?</td>
              <td><input type="radio" name="q15" value="5"></td>
              <td><input type="radio" name="q15" value="4"></td>
              <td><input type="radio" name="q15" value="3"></td>
              <td><input type="radio" name="q15" value="2"></td>
              <td><input type="radio" name="q15" value="1"></td>
            </tr>
            <tr>
              <td class="Question_GBI">16. Depuis votre intervention, êtes-vous plus (ou moins) gêné(e) par votre problème auditif ? </td>
              <td><input type="radio" name="q16" value="1"></td>
              <td><input type="radio" name="q16" value="2"></td>
              <td><input type="radio" name="q16" value="3"></td>
              <td><input type="radio" name="q16" value="4"></td>
              <td><input type="radio" name="q16" value="5"></td>
            </tr>
            <tr>
              <td class="Question_GBI">17. Depuis votre intervention, avez-vous pu participer à plus (ou moins) d’activités en société ?</td>
              <td><input type="radio" name="q17" value="5"></td>
              <td><input type="radio" name="q17" value="4"></td>
              <td><input type="radio" name="q17" value="3"></td>
              <td><input type="radio" name="q17" value="2"></td>
              <td><input type="radio" name="q17" value="1"></td>
            </tr>
            <tr>
              <td class="Question_GBI">18. Depuis votre intervention, avez-vous plus (ou moins) besoin de vous retrouver seul(e) ?</td>
              <td><input type="radio" name="q18" value="1"></td>
              <td><input type="radio" name="q18" value="2"></td>
              <td><input type="radio" name="q18" value="3"></td>
              <td><input type="radio" name="q18" value="4"></td>
              <td><input type="radio" name="q18" value="5"></td>
            </tr>

          </tbody>
        </table>
      <div class="buttons-container">
        <button type="button" onclick="calculateScore()">Calculer le Score</button>
        <button type="reset" onclick="resetForm()">Réinitialiser</button>
      </div>
    </form>

    <div id="results" style="display:none">
      <p id="scoreDisplay"></p><br>
      <label for="nameID" class="Subject_name">Nom du sujet (si besoin)</label>
      <input type="text" id="ID" name="nameID"><br>
      <button id="savePdfButton" onclick="savePdf()">Exporter en PDF</button>
      <button id="saveXLSbutton" onclick="saveXLS()">Exporter en XLS</button>
    </div>

    <script>

        const GBI = {
          gbiScore: null,
          generalBenefitSubscale: null,
          socialSupportSubscale: null,
          physicalHealthSubscale: null
        };

        

        // This function is responsible for calculating the GBI and subscale scores.
        function calculateScore() {
          let totalScore = 0;
          let answeredQuestions = 0;

          // Define questions for each subscale
          const generalBenefitQuestions = ['q1', 'q2', 'q3', 'q5', 'q6', 'q7', 'q14', 'q15', 'q17'];
          let generalBenefitScore = 0;
          let generalBenefitAnswered = 0;

          const socialSupportQuestions = ['q4', 'q10', 'q11', 'q18'];
          let socialSupportScore = 0;
          let socialSupportAnswered = 0;

          const physicalHealthQuestions = ['q8', 'q9', 'q12', 'q13', 'q16'];
          let physicalHealthScore = 0;
          let physicalHealthAnswered = 0;

          // Loop through all 18 questions to collect scores
          for (let i = 1; i <= 18; i++) {
            const qName = 'q' + i;
            const selectedOption = document.querySelector(`input[name="${qName}"]:checked`);

            if (selectedOption) {
              const value = parseInt(selectedOption.value);
              totalScore += value;
              answeredQuestions++;

              // Assign scores to respective subscales
              if (generalBenefitQuestions.includes(qName)) {
                generalBenefitScore += value;
                generalBenefitAnswered++;
              } else if (socialSupportQuestions.includes(qName)) {
                socialSupportScore += value;
                socialSupportAnswered++;
              } else if (physicalHealthQuestions.includes(qName)) {
                physicalHealthScore += value;
                physicalHealthAnswered++;
              }
            }
          }

          // Handle cases where not all questions are answered for a subscale
          if (answeredQuestions < 18) {
            const resultDiv = document.getElementById("results");
            resultDiv.innerHTML = "<p class=Error_message_not_all_answered>Veuillez répondre svp à toutes les questions avant de calculer le score!</p>";
            resultDiv.style.display = "block"; 
            return;
          }


          // --- Score Calculation ---
          // The GBI uses a specific normalization.
          // Each question score (1-5) is normalized around 0 (3 = 0, 5 = +2, 1 = -2).
          // Then, the normalized sum is divided by the maximum possible positive sum
          // (number of questions * 2, since max positive for one question is 2),
          // and multiplied by 100 to scale to a -100 to +100 range.

          const calculateSubscaleScore = (scoreSum, answeredCount) => {
            if (answeredCount === 0) {
              return 0; // Avoid division by zero if no questions were answered for this subscale
            }
            const normalizedSum = scoreSum - (3 * answeredCount);
            return (normalizedSum / (2 * answeredCount)) * 100;
          };

          const gbiScore = calculateSubscaleScore(totalScore, answeredQuestions);
          const generalBenefitSubscale = calculateSubscaleScore(generalBenefitScore, generalBenefitAnswered);
          const socialSupportSubscale = calculateSubscaleScore(socialSupportScore, socialSupportAnswered);
          const physicalHealthSubscale = calculateSubscaleScore(physicalHealthScore, physicalHealthAnswered);

          // Display the calculated scores
          displayResults(gbiScore, generalBenefitSubscale, socialSupportSubscale, physicalHealthSubscale);

          // Return score for xls and pdf
          GBI.gbiScore = gbiScore;
          GBI.generalBenefitSubscale = generalBenefitSubscale;
          GBI.socialSupportSubscale = socialSupportSubscale;
          GBI.physicalHealthSubscale = physicalHealthSubscale;


        }

      // This function is purely for displaying the scores in the designated HTML element.
      function displayResults(gbiScore, generalBenefitSubscale, socialSupportSubscale, physicalHealthSubscale) {
        let display = "<p>Résultats</p>";
        display += "<br>";
        display += "<ul class='myList'>";
        display += "<li>Score Total GBI : " + gbiScore.toFixed(2) + "</li>";
        display += "<li>Bénéfice Général : " + generalBenefitSubscale.toFixed(2) + "</li>";
        display += "<li>Soutien Social : " + socialSupportSubscale.toFixed(2) + "</li>";
        display += "<li>Santé Physique : " + physicalHealthSubscale.toFixed(2) + "</li>";
        display += "</ul>";
        display += "<p> Les scores vont de -100 (bénéfices négatifs) à +100 (bénéfices positifs). </p>";

        // Update the results div with the constructed HTML
        document.getElementById("scoreDisplay").innerHTML = display;
        document.getElementById("results").style.display = "block";
        document.getElementById('savePdfButton').style.display = 'inline-block';
        document.getElementById('saveXLSbutton').style.display = 'inline-block';


      }

      function saveXLS() {

        const subjectCode = document.getElementById('ID').value || "SansNom";
        const today = new Date().toLocaleDateString('fr-FR');
        const filename = `GBI_${today}_${subjectCode}.csv`;

        // Récupérer les réponses
        let answers = [];
        for (let i = 1; i <= 18; i++) {
            const selectedOption = document.querySelector(`input[name="q${i}"]:checked`);
            answers.push(selectedOption ? selectedOption.value : "NA");
        }

        // Calculer les scores
        const safeTotal = typeof GBI.gbiScore === 'number' ? GBI.gbiScore.toFixed(2) : "NA";
        const safeGeneral = typeof GBI.generalBenefitSubscale === 'number' ? GBI.generalBenefitSubscale.toFixed(2) : "NA";
        const safeSocial = typeof GBI.socialSupportSubscale === 'number' ? GBI.socialSupportSubscale.toFixed(2) : "NA";
        const safePhysique = typeof GBI.physicalHealthSubscale === 'number' ? GBI.physicalHealthSubscale.toFixed(2) : "NA";



        // Créer le contenu CSV
        let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
        csvContent += "Sujet,Date,Questionnaire,Total,General,Social,Physique,";
        for (let i = 1; i <= 18; i++) {
            csvContent += `Q${i},`;
        }
        csvContent += "\n";
        let row = `"${subjectCode}","${today}","GBI","${safeTotal}","${safeGeneral}","${safeSocial}","${safePhysique}",`;
        row += answers.join(",");
        csvContent += row + "\n";

        // Télécharger le fichier
        const link = document.createElement("a");
        link.setAttribute("href", encodeURI(csvContent));
        link.setAttribute("download", filename);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      function savePdf() {

          const { jsPDF } = window.jspdf;
          const today = new Date().toLocaleDateString('fr-FR');
          const subjectCode = document.getElementById('ID').value || "SansNom";
          const filename = `GBI_${today}_${subjectCode}.pdf`;

          // Calculer les scores
          const safeTotal = typeof GBI.gbiScore === 'number' ? GBI.gbiScore.toFixed(2) : "NA";
          const safeGeneral = typeof GBI.generalBenefitSubscale === 'number' ? GBI.generalBenefitSubscale.toFixed(2) : "NA";
          const safeSocial = typeof GBI.socialSupportSubscale === 'number' ? GBI.socialSupportSubscale.toFixed(2) : "NA";
          const safePhysique = typeof GBI.physicalHealthSubscale === 'number' ? GBI.physicalHealthSubscale.toFixed(2) : "NA";



          let data2table = "<table>";
          let answers = [];

          for (let i = 1; i <= 18; i++) {
            const selectedOption = document.querySelector(`input[name="q${i}"]:checked`);
            const answer = selectedOption ? selectedOption.value : "NA";
            answers.push(answer);

            // Ouvrir une ligne toutes les deux questions
            if (i % 2 === 1) {
              data2table += "<tr>";
            }

            data2table += `<td>Q${i} : ${answer}</td>`;

            // Fermer la ligne après deux colonnes ou à la dernière question
            if (i % 2 === 0 || i === 18) {
              data2table += "</tr>";
            }
          }

          data2table += "</table>";

         
          const content = document.createElement('div');
          content.innerHTML = `
            <style>
            @page {
                size: A4;
                margin: 0;
              }  
            .header_report,
            .body_report,
            .footer_report {
            text-align: center;
            margin: 0 auto;
            width: 100%;
            }
            .header_report {
            padding-top: 4%;
            padding-bottom: 4%;
            background-color:white; /*color for test*/
            border-bottom: 1px solid #2B176C;
            }
            .footer_report {
            padding-top: 3%;
            padding-bottom:3%;

            }
            .body_report {
            padding-top: 5%;
            padding-bottom:20%;
            background-color: white;
            color: black; 
            }


            table {
              border-collapse: collapse;
              width: 80%;
              margin-top: 20px;
              margin: 0 auto;
            }

            th, td {
              padding: 6px 12px;
              border: 1px solid #eeeeee;
          }
            td strong {
              display: block;
              text-align: left;
            }


            </style>
            <div class="header_report">
            <img src="https://data.memau.eu/wp-content/uploads/2025/06/logo-memau-data.svg" alt="Logo" style="max-width: 210px; 
            margin-top: 10px;margin-bottom: 5px;">
            <p><i>Contact : hello@memau.eu </i></p>
                  </div>    
            <div class="body_report">
              <h1>GBI</h1>
              <p>Code du Sujet : ${subjectCode} </p>
              <p>Rapport généré le : ${today}</p>
              <p>Score total&nbsp:&nbsp;${safeTotal}</p>
              <p>Bénéfice Général :&nbsp;${safeGeneral}</p>
              <p>Soutien Social :&nbsp;${safeSocial}</p>
              <p>Santé Physique :&nbsp;${safePhysique}</p>
              <p>Score de chaque question</p>

              <div class="data2columns">
                ${data2table}
              </div>
            </div>
            `;

        

            document.body.appendChild(content);

            // Use html2pdf to convert the HTML content to PDF
            const opt = {
              margin: [10, 10, 10, 10], // Adjusted margin to ensure content is visible
              filename: filename,
              image: { type: 'jpeg', quality: 0.98 },
              html2canvas: { scale: 2, useCORS: true,scrollY: 0  },
              jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            // Generate PDF from HTML content
            html2pdf().set(opt).from(content).save().then(() => {
              document.body.removeChild(content);
            });
      }
      
      // This function resets the form and clears the displayed results.
      function resetForm() {
            // Réinitialiser les variables globales
            if (GBI) {
                GBI.gbiScore = null;
                GBI.generalBenefitSubscale = null;
                GBI.socialSupportSubscale = null;
                GBI.physicalHealthSubscale = null;
            }

            // Réinitialiser le formulaire
            const form = document.getElementById("GBI");
            if (form) form.reset();

            // Réinitialiser le champ "Nom du sujet"
            const subjectField = document.getElementById("ID");
            if (subjectField) subjectField.value = "";

            // Supprimer les messages d'erreur
            const errorMessages = document.querySelectorAll(".Error_message_not_all_answered");
            errorMessages.forEach(errorMsg => errorMsg.remove());

            // Masquer les boutons d'export
            const pdfBtn = document.getElementById('savePdfButton');
            if (pdfBtn) pdfBtn.style.display = 'none';

            const xlsBtn = document.getElementById('saveXLSbutton');
            if (xlsBtn) xlsBtn.style.display = 'none';

            // Masquer la div des résultats
            const resultsDiv = document.getElementById('results');
            if (resultsDiv) {
                resultsDiv.style.display = 'none';
                resultsDiv.innerHTML = ""; // Optionnel : vider le contenu
            }
        }


      
        
    </script>
  </body>
</html>
