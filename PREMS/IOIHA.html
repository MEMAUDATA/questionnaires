<!DOCTYPE html>
<html lang="fr">
  <head>
    <!-- Author's details-->
    <meta name="author" content="Nicolas Vannson">
    <meta name="contact" content="hello@memau.eu">
    <meta name="license" content="EUPLv1.2">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/3.0.0/jspdf.umd.min.js"></script>
    <script src= https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="/style.css">
    <style>
      /* style is within the style.css sheet */
    </style>
    <title>IIPBAA</title>
  </head>
  <body>
    <h1>Inventaire international portant sur les bénéfices des aides auditives <br> (IIPBAA ou IOI-HA en anglais)</h1>
    <p >Cox et al., 2000 (version originale)<br>
      Cox,Stephens & Kramer 2002 (version traduite en français)</p>
    <br>
    <form id="IIPBAA">
      <table>
        <tbody>
          <tr>
            <td>
              <p class="IIPBAA_question" >1. Durant les deux dernières semaines, si vous avez utilisé votre(vos) appareil(s) auditif(s), indiquez combien d’heures par jour en moyenne</p>
              <br> 
              <div class="IIPBAA_answer">
                <label>jamais<br><input type="radio" name="q1" value="1"></label>
                <label>moins d’une 1 heure/jour<br><input type="radio" name="q1" value="2"></label>
                <label>1 à 4 hr/jour<br><input type="radio" name="q1" value="3"></label>
                <label>4 à 8hr/jour<br><input type="radio" name="q1" value="4"></label>
                <label>plus de 8 hr/jour<br><input type="radio" name="q1" value="5"></label>
              </div>
            </td>
          </tr>
          <tr>
            <td>
                <p class="IIPBAA_question">2. Souvenez-vous des situations dans lesquelles vous aviez le plus envie d’entendre mieux avant d’avoir votre appareillage auditif. Durant les deux dernières semaines, votre appareillage vous a-t-il aidé dans
                  ces situations?</p>
              <br> 
              <div class="IIPBAA_answer">
                <label>Jamais aidé<br><input type="radio" name="q2" value="1"></label>
                <label>Légèrement aidé<br><input type="radio" name="q2" value="2"></label>
                <label>Modérément aidé<br><input type="radio" name="q2" value="3"></label>
                <label>Nettement aidé<br><input type="radio" name="q2" value="4"></label>
                <label>Beaucoup aidé<br><input type="radio" name="q2" value="5"></label>
              </div>
            </td>
          </tr>

          <tr>
            <td>
                <p class="IIPBAA_question">3. Souvenez-vous des situations dans lesquelles vous aviez le plus envie d’entendre mieux. Quand vous utilisez maintenant votre appareillage auditif, avez-vous ENCORE des difficultés ?</p>
              <br>
              <div class="IIPBAA_answer">
                <label>Beaucoup difficultés<br><input type="radio" name="q3" value="1"></label>
                <label>Nettes difficultés<br><input type="radio" name="q3" value="2"></label>
                <label>Difficultés modérées<br><input type="radio" name="q3" value="3"></label>
                <label>Légères difficultés<br><input type="radio" name="q3" value="4"></label>
                <label>Aucune difficulté<br><input type="radio" name="q3" value="5"></label>
              </div>
            </td>
          </tr>

          <tr>
            <td>
                <p class="IIPBAA_question">4. Tout compte fait, pensez-vous que votre appareillage auditif actuel présente un intérêt?</p>
              <br>
              <div class="IIPBAA_answer">
                <label>Aucun intérêt<br><input type="radio" name="q4" value="1"></label>
                <label>Un léger intérêt<br><input type="radio" name="q4" value="2"></label>
                <label>Un intérêt modéré<br><input type="radio" name="q4" value="3"></label>
                <label>Un net intérêt<br><input type="radio" name="q4" value="4"></label>
                <label>Un grand intérêt<br><input type="radio" name="q4" value="5"></label>
              </div>
            </td>
          </tr>

          <tr>
            <td>
                <p class="IIPBAA_question">5. Durant les deux dernières semaines, avec votre appareillage auditif actuel, à quel point vos difficultés auditives ont-elles gêné ou affecté les choses que vous pouvez faire?</p>
              <br>  
              <div class="IIPBAA_answer">
                <label>Beaucoup gêné<br><input type="radio" name="q5" value="1"></label>
                <label>Nettement gêné<br><input type="radio" name="q5" value="2"></label>
                <label>Modérément gêné<br><input type="radio" name="q5" value="3"></label>
                <label>Légèrement gêné<br><input type="radio" name="q5" value="4"></label>
                <label>Pas du tout gêné<br><input type="radio" name="q5" value="5"></label>
              </div>
            </td>
          </tr>
          <tr>
            <td>
                <p class="IIPBAA_question">6. Durant les deux dernières semaines, avec votre appareillage auditif actuel, à quel point pensez-vous que vos difficultés auditives ont ennuyé les autres?</p>
              <br>
              <div class="IIPBAA_answer">
                <label>Beaucoup ennuyé<br><input type="radio" name="q6" value="1"></label>
                <label>Nettement ennuyé<br><input type="radio" name="q6" value="2"></label>
                <label>Modérément ennuyé<br><input type="radio" name="q6" value="3"></label>
                <label>Beaucoup ennuyé<br><input type="radio" name="q6" value="4"></label>
                <label>Pas du tout ennuyé<br><input type="radio" name="q6" value="5"></label>
              </div>
            </td>
          </tr>
          <tr>
            <td>
                <p class="IIPBAA_question">7. Tout compte fait, votre vie et ses plaisisrs ont-ils changé depuis votre appareillage auditif ?</p>
              <br>
              <div class="IIPBAA_answer">
                <label>Pire qu’avant<br><input type="radio" name="q7" value="1"></label>
                <label>Pas de changement<br><input type="radio" name="q7" value="2"></label>
                <label>Légèrement mieux<br><input type="radio" name="q7" value="3"></label>
                <label>Nettement mieux<br><input type="radio" name="q7" value="4"></label>
                <label>Beaucoup mieux<br><input type="radio" name="q7" value="5"></label>
              </div>
            </td>
          </tr>

          <tr>
            <td>
                <p class="IIPBAA_question">8. Quel est votre niveau de perte auditive lorsque vous <b>ne</b> portez <b>pas</b> votre appareillage auditif ?</p>
              <br>    
              <div class="IIPBAA_answer">
                <label>Profonde<br><input type="radio" name="q8" value="1"></label>
                <label>Sévère<br><input type="radio" name="q8" value="2"></label>
                <label>Moyenne<br><input type="radio" name="q8" value="3"></label>
                <label>Légère<br><input type="radio" name="q8" value="4"></label>
                <label>Aucune<br><input type="radio" name="q8" value="5"></label>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
      <div class="buttons-container">
        <button type="button" onclick="calculerScores()">Calculer les scores</button>
        <button type="reset" onclick="resetForm()">Réinitialiser</button>
      </div>
    </form>
    <div id="results" style="display:none">
      <p id="scoreDisplay"></p><br>
      <label for="nameID" class="Subject_name">Nom du sujet (si besoin)</label>
      <input type="text" id="ID" name="nameID"><br>
      <button id="savePdfButton" onclick="savePdf()">Exporter en PDF</button>
      <button id="saveXLSbutton" onclick="saveXLS()">Exporter en XLS</button>
    </div>
    
    <script>

      function calculerScores() {
          let allAnswered = true;

          for (let i = 1; i <= 8; i++) {
            let q = document.querySelector(`input[name="q${i}"]:checked`);
            if (!q) {
              allAnswered = false;
              break;
            }
          }

          //if (!allAnswered) return;

          const resp = document.getElementById("IIPBAA");

          // Assign actual scores only once
          let use = parseInt(resp.elements["q1"].value);
          let ben = parseInt(resp.elements["q2"].value);
          let ral = parseInt(resp.elements["q3"].value);
          let sat = parseInt(resp.elements["q4"].value);
          let rpr = parseInt(resp.elements["q5"].value);
          let iot = parseInt(resp.elements["q6"].value);
          let qol = parseInt(resp.elements["q7"].value);
          let perte = parseInt(resp.elements["q8"].value);

          // Determine norms based on perte
          let [n_use, n_ben, n_ral, n_sat, n_rpr, n_iot, n_qol] = perte >= 3
            ? [3, 3, 3, 2, 3, 3, 3]
            : [4, 3, 2, 3, 3, 2, 3];

          displayscores(use, ben, ral, sat, rpr, iot, qol, n_use, n_ben, n_ral, n_sat, n_rpr, n_iot, n_qol);
        }

      function displayscores(use, ben, ral, sat, rpr, iot, qol, n_use,n_ben,n_ral,n_sat,n_rpr,n_iot,n_qol){
        let display = "<p>Résultats</p>";
        display += "<br>"; 
        display += "<ul class='myList'>"; 
        display += "<li>Temps de port : " + use + " (norme: " + n_use + ")" +  "</li>";
        display += "<li>Bénéfice de l’appareillage auditif : " + ben + " (norme: " + n_ben + ")" + "</li>";
        display += "<li>Limitations résiduelles : " + ral + " (norme: " + n_ral + ")" + "</li>";
        display += "<li>Niveau de satisfaction : " + sat + " (norme: " + n_sat + ")" + "</li>";
        display += "<li>Restrictions résiduelles : " + rpr + " (norme: " + n_rpr + ")" +"</li>";
        display += "<li>Impact de l’appareillage sur les autres : " + iot + " (norme: " + n_iot + ")" + "</li>";
        display += "<li>Niveau de qualité de vie : " + qol + " (norme: " + n_qol + ")" + "</li>";
        display += "</ul>";
        // Update the results div with the constructed HTML
        document.getElementById("scoreDisplay").innerHTML = display;
        document.getElementById("results").style.display = "block";
        document.getElementById('savePdfButton').style.display = 'inline-block';
        document.getElementById('saveXLSbutton').style.display = 'inline-block';
      }
      
      

      function resetForm() {
        document.getElementById("IIPBAA").reset();
        // Reset subject's name
        document.getElementById("ID").value = "";
        document.getElementById('results').style.display = 'none';
        // Hide the save PDF button on reset
        document.getElementById('savePdfButton').style.display = 'none';
        document.getElementById('saveXLSbutton').style.display = 'none';
      }
      
      
       function saveXLS() {

        const subjectCode = document.getElementById('ID').value || "SansNom"; // Nom du sujet
        const today = new Date().toLocaleDateString('fr-FR');
        const filename = `IOIHA_${today}_${subjectCode}.csv`;


        let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
        csvContent += "Sujet,Date,Questionnaire,use, ben, ral, sat, rpr, iot, qol";
        csvContent += "\n";

        let row = `"${subjectCode}","${today}","SHQ"`;
        for (let i = 1; i <8 ; i++) {
          const resp = document.getElementById("IIPBAA");
          var answer = parseInt(resp.elements[`q${i}`].value); 
          row += `,"${answer}"`;
        }    

        csvContent += row + "\n";

        const link = document.createElement("a");
        link.setAttribute("href", encodeURI(csvContent));
        link.setAttribute("download", filename);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }


		function savePdf() {
          const { jsPDF } = window.jspdf;
          const today = new Date().toLocaleDateString('fr-FR');
          const subjectCode = document.getElementById('ID').value || "SansNom";
          const filename = `IOIHA_${today}_${subjectCode}.pdf`;

        
		const col = [
          "Temps de port", "Bénéfice de l’appareillage auditif",
          "Limitations résiduelles", "Niveau de satisfaction",
          "Restrictions résiduelles", "Impact de l’appareillage sur les autres",
          "Niveau de qualité de vie"
        ];

		const resp = document.getElementById("IIPBAA");
        
        let perte = parseInt(resp.elements["q8"].value);
        let [n_use, n_ben, n_ral, n_sat, n_rpr, n_iot, n_qol] = perte >= 3
            ? [3, 3, 3, 2, 3, 3, 3]
            : [4, 3, 2, 3, 3, 2, 3];

	      const norms = [n_use, n_ben, n_ral, n_sat, n_rpr, n_iot, n_qol];
        
        // Type of hearing loss
        const perteLabels = {
              1: "Profonde",
              2: "Sévère",
              3: "Moyenne",
              4: "Légère",
              5: "Aucune"
            };

		  let type_de_perte = perteLabels[perte] || "Inconnue";
    
        let data2table = "<table>";
        for (let i = 0; i < 7; i++) {
        	const resp = document.getElementById("IIPBAA");
            var answer = parseInt(resp.elements[`q${i + 1}`].value);
            const norm = norms[i];
            const status = answer >= norm ? "✅" : "⚠️";
            data2table += `
              <tr>
              <td><strong>${col[i]}</strong></td>
              <td> ${answer}</td>
              <td>→ Norme </td>
              <td>${norms[i]} ${status} </td></tr>`;}
          data2table += "</table>";
        

      const content = document.createElement('div');
      content.innerHTML = `
        <style>
        .header_report,
        .body_report,
        .footer_report {
        text-align: center;
        margin: 0 auto;
        width: 100%;
        }
        .header_report {
        padding-top: 4%;
        padding-bottom: 4%;
        background-color:white; /*color for test*/
        border-bottom: 1px solid #2B176C;
        }
        .footer_report {
        padding-top: 3%;
        padding-bottom:3%;

        }
        .body_report {
        padding-top: 5%;
        padding-bottom:20%;
        background-color: white;
        color: black; 
        }


		table {
          border-collapse: collapse;
          width: 80%;
          margin-top: 20px;
          margin: 0 auto;
      	}

        th, td {
          padding: 6px 12px;
          border: 1px solid #eeeeee;
      }
        td strong {
          display: block;
          text-align: left;
        }


        </style>
        <div class="header_report">
        <img src="https://data.memau.eu/wp-content/uploads/2025/06/logo-memau-data.svg" alt="Logo" style="max-width: 210px; 
        margin-top: 10px;margin-bottom: 5px;">
        <p><i>Contact : hello@memau.eu </i></p>
              </div>    
        <div class="body_report">
        <h1>IOI-HA</h1>
        <p>Code du Sujet : ${subjectCode} </p>
        <p>Rapport généré le : ${today}</p>
         <p>Perte auditive sans appareil(s) : ${type_de_perte}</p>
        <br>
        ${data2table}	
        </div>
        `;


      document.body.appendChild(content);

      // Use html2pdf to convert the HTML content to PDF
      const opt = {
        margin: [10, 10, 10, 10], // Adjusted margin to ensure content is visible
        filename: filename,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true,scrollY: 0  },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
      };

      // Generate PDF from HTML content
      html2pdf().set(opt).from(content).save().then(() => {
        document.body.removeChild(content);
      });
      }				

    </script>
  </body>
</html>

